\pgfmathsetmacro{\phi}{0.1}
\pgfmathsetmacro{\sp}{4.5}


%%%%%%%%%%%%%%%%%%%%%%%%
% State 1
%%%%%%%%%%%%%%%%%%%%%%%%

\pgfmathsetmacro{\bs}{0}
\pgfmathsetmacro{\bsy}{0}

% Memory
\draw[rounded corners] (\bs+0,0) rectangle (\bs+4, 8); 

% External disk
\draw[rounded corners] (\bs+\sp,0) rectangle (\bs+\sp+4, 8); 

\foreach \x in {0, 1, 2} {
  \draw[rounded corners] (\bs+\sp+\phi,\x*2+\phi) rectangle (\bs+\sp+4-\phi, \x*2+2-\phi);
  \node (\x) at (\bs+\sp+2,\x*2+1) {$Open(\x)$};
}

\draw[rounded corners] (\bs+\phi,2*2+\phi) rectangle (\bs+4-\phi, 2*2+2-\phi);
\node (mem2) at (\bs+2,2*2+1) {$Open(2)$};

\draw[rounded corners] (\bs+\phi,2*2+2+\phi) rectangle (\bs+4-\phi, 2*2+2+2-\phi);
\node (a2) at (\bs+2,2*2+2+1) {$A(3)$};
\draw[->] (mem2) -- (a2);

\node at ({\bs + (\sp + 4) / 2}, -1) {1. Expand $Open(i-1)$};

\node at ({\bs + 2}, \bsy+8.5) {Main Memory};
\node at ({\bs + \sp + 2}, \bsy+8.5) {External Memory};

%%%%%%%%%%%%%%%%%%%%%%%%
% State 2
%%%%%%%%%%%%%%%%%%%%%%%%

\pgfmathsetmacro{\bs}{10}
\pgfmathsetmacro{\bsy}{0}

% Memory
\draw[rounded corners] (\bs+0,0) rectangle (\bs+4, 8); 

% External disk
\draw[rounded corners] (\bs+\sp,0) rectangle (\bs+\sp+4, 8); 

\foreach \x in {0, 1, 2} {
  \draw[rounded corners] (\bs+\sp+\phi,\x*2+\phi) rectangle (\bs+\sp+4-\phi, \x*2+2-\phi);
  \node (\x) at (\bs+\sp+2,\x*2+1) {$Open(\x)$};
}

\draw[rounded corners] (\bs+\phi,2*2+\phi) rectangle (\bs+4-\phi, 2*2+2-\phi);
\node (mem2) at (\bs+2,2*2+1) {$Open(2)$};

\draw[rounded corners] (\bs+\phi,2*2+2+\phi) rectangle (\bs+4-\phi, 2*2+2+2-\phi);
\node[align=center,font=\footnotesize] (a2) at (\bs+2,2*2+2+1) {$A(3)$\\$\setminus Open(2)$};
\draw[->] (mem2) -- (a2);

\node at ({\bs + (\sp + 4) / 2}, -1) {2. Duplicate Detection with $Open(i-1)$};

\node at ({\bs + 2}, \bsy+8.5) {Main Memory};
\node at ({\bs + \sp + 2}, \bsy+8.5) {External Memory};


%%%%%%%%%%%%%%%%%%%%%%%%
% State 3
%%%%%%%%%%%%%%%%%%%%%%%%

\pgfmathsetmacro{\bs}{0}
\pgfmathsetmacro{\bsy}{-11}

% Memory
\draw[rounded corners] (\bs+0,\bsy+0) rectangle (\bs+4, \bsy+8); 

% External disk
\draw[rounded corners] (\bs+\sp,\bsy+0) rectangle (\bs+\sp+4, \bsy+8); 

\foreach \x in {0, 1, 2} {
  \draw[rounded corners] (\bs+\sp+\phi,\bsy+\x*2+\phi) rectangle (\bs+\sp+4-\phi, \bsy+\x*2+2-\phi);
  \node (\x) at (\bs+\sp+2,\bsy+\x*2+1) {$Open(\x)$};
}

\draw[rounded corners] (\bs+\phi,\bsy+2*1+\phi) rectangle (\bs+4-\phi, \bsy+2*1+2-\phi);
\node (mem1) at (\bs+2,\bsy+2*1+1) {$Open(1)$};

\draw[rounded corners] (\bs+\phi,\bsy+2*2+2+\phi) rectangle (\bs+4-\phi, \bsy+2*2+2+2-\phi);
\node[align=center,font=\footnotesize] (a2) at (\bs+2,\bsy+2*2+2+1) {$A(3)$\\$\setminus Open(2)$\\$\setminus Open(1)$};
\draw[->] (mem1) -- (a2);

\node at ({\bs + (\sp + 4) / 2}, \bsy-1) {3. Duplicate Detection with $Open(i-2)$};

\node at ({\bs + 2}, \bsy+8.5) {Main Memory};
\node at ({\bs + \sp + 2}, \bsy+8.5) {External Memory};



%%%%%%%%%%%%%%%%%%%%%%%%
% State 4
%%%%%%%%%%%%%%%%%%%%%%%%

\pgfmathsetmacro{\bs}{10}
\pgfmathsetmacro{\bsy}{-11}

% Memory
\draw[rounded corners] (\bs+0,\bsy+0) rectangle (\bs+4, \bsy+8); 

% External disk
\draw[rounded corners] (\bs+\sp,\bsy+0) rectangle (\bs+\sp+4, \bsy+8); 

\foreach \x in {0, 1, 2, 3} {
  \draw[rounded corners] (\bs+\sp+\phi,\bsy+\x*2+\phi) rectangle (\bs+\sp+4-\phi, \bsy+\x*2+2-\phi);
  \node (\x) at (\bs+\sp+2,\bsy+\x*2+1) {$Open(\x)$};
}

\draw[rounded corners] (\bs+\phi,\bsy+2*2+2+\phi) rectangle (\bs+4-\phi, \bsy+2*2+2+2-\phi);
\node[align=center,font=\footnotesize] (a2) at (\bs+2,\bsy+2*2+2+1) {$A(3)$\\$\setminus Open(2)$\\$\setminus Open(1)$};

\draw[->] (a2) -- (3);

\node at ({\bs + (\sp + 4) / 2}, \bsy-1) {4. Store $Open(i)$};

\node at ({\bs + 2}, \bsy+8.5) {Main Memory};
\node at ({\bs + \sp + 2}, \bsy+8.5) {External Memory};
